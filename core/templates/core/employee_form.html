{% extends 'core/dashboard_base.html' %}
{% load static %}

{% block dashboard_title %}
{% if form.instance.pk %}Edit Employee{% else %}Add Employee{% endif %}
{% endblock %}

{% block page_title %}
{% if form.instance.pk %}Edit Employee: {{ form.instance.full_name }}{% else %}Add New Employee{% endif %}
{% endblock %}

{% block dashboard_content %}
<form method="post" class="card">
    {% csrf_token %}

    <h3>Basic Details</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        {% for field in form %}
        <div style="flex: 1 1 300px; min-width: 250px;" class="{% if field.errors %}has-error{% endif %}">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <ul class="errorlist">
                {% for error in field.errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <hr>
    <h3>Allowances</h3>
    <p class="text-secondary" style="font-size: 0.9em;">Manage allowances for this employee. Click "Add another" to add
        a new allowance.</p>

    {{ formset.management_form }}
    {% if formset.non_form_errors %}
    <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
    {% endif %}
    {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    <div id="allowance-formset" style="display: flex; flex-wrap: wrap; gap: 1rem;">
        {% for form in formset %}
        <div class="allowance-row card-sub"
            style="flex: 1 1 200px; display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
            {{ form.id }}
            {{ form.allowance }} <!-- Hidden input stores the ID -->

            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                {# Robust logic to show name: #}
                {# 1. Try instance (works for Edit mode and Bound forms with valid data) #}
                {# 2. Try initial (works for Add mode GET request) #}
                {% if form.instance.allowance %}
                {{ form.instance.allowance.name }}
                {% elif form.initial.allowance %}
                {{ form.initial.allowance.name }}
                {% endif %}
            </div>

            <div class="{% if form.amount.errors %}has-error{% endif %}">
                {# <label>{{ form.amount.label }}</label> #}
                {{ form.amount }}
            </div>

            {# Delete button removed as per requirement to show all 5 always #}
        </div>
        {% if form.errors %}
        <div class="text-danger">
            {{ form.errors }}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="form-actions" style="margin-top: 2rem;">
        <button type="submit" class="btn btn-primary">Save Employee</button>
        <a href="{% url 'employee_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}